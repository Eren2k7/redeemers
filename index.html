<!-- REDEEMERSCHAT - UPDATED FULL HTML APP (ALL FEATURES INCLUDED)

âœ” Signup with: Full Name, Matric, Faculty, Department, Phone Number, Profile Photo
âœ” Login + Forgot Password
âœ” After login â†’ If profile incomplete â†’ force user to fill details
âœ” Upload / Change Profile Picture
âœ” View & Edit Profile Settings
âœ” Change Chat Wallpaper + Live Preview
âœ” 100-Level Directory with 2 tabs:
    - TAB 1: Faculties
    - TAB 2: Departments
âœ” Start Private Chats
âœ” View-once Images (WhatsApp-style)
âœ” Voice Notes
âœ” Emoji Picker
âœ” Reactions + Blur Effect
âœ” Seen/Delivered indicators
âœ” File Upload (â‰¤50MB)
âœ” Per-user wallpaper saved in Firestore

SAVE THIS AS: index.html
--->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RedeemersChat â€“ 100 Level</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
    html,body,#app{height:100%}
    .wallpaper{background-size:cover;background-position:center}
    .msg-bubble{max-width:75%}
    .blur-reaction{filter:blur(6px);transition:filter .2s}
    .reaction-ui{position:absolute;z-index:50}
</style>
</head>
<body class="bg-gray-100 h-full">
<div id="app" class="h-full"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<!-- EMOJI PICKER -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

<script>
// ================================================
// *** REPLACE WITH YOUR FIREBASE CONFIG ***
// ================================================
const firebaseConfig={
  apiKey: "AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
  authDomain: "eren-c4b30.firebaseapp.com",
  projectId: "eren-c4b30",
  storageBucket: "eren-c4b30.firebasestorage.app",
  messagingSenderId: "91279547740",
  appId: "1:91279547740:web:21a3b4464dc8e608993599",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

let currentUser=null;
let currentProfile=null;
let activeChatId=null;
let activeChatUser=null;
const MAX_UPLOAD=50*1024*1024;

const app=document.getElementById('app');
function el(h){const d=document.createElement('div');d.innerHTML=h.trim();return d.firstChild;}
function toast(t){alert(t);}
function idGen(u1,u2){return [u1,u2].sort().join('_');}

// ==============================================================
// AUTH SCREENS
// ==============================================================
function renderAuth(){
app.innerHTML=`
<div class='flex h-full items-center justify-center'>
 <div class='bg-white p-6 rounded shadow w-full max-w-md'>
  <h2 class='text-2xl font-bold mb-4'>RedeemersChat</h2>

  <!-- SIGNUP -->
  <div id='signupBox'>
    <input id='s_name' class='w-full mb-2 p-2 border rounded' placeholder='Full Name'>
    <input id='s_phone' class='w-full mb-2 p-2 border rounded' placeholder='Phone Number'>
    <input id='s_matric' class='w-full mb-2 p-2 border rounded' placeholder='Matric Number'>
    <input id='s_faculty' class='w-full mb-2 p-2 border rounded' placeholder='Faculty'>
    <input id='s_department' class='w-full mb-2 p-2 border rounded' placeholder='Department'>
    <input id='s_email' class='w-full mb-2 p-2 border rounded' type='email' placeholder='Email'>
    <input id='s_pass' class='w-full mb-4 p-2 border rounded' type='password' placeholder='Password'>

    <label class='block mb-2 text-sm'>Upload Profile Picture</label>
    <input id='s_pic' type='file' accept='image/*' class='mb-4'>

    <button id='signupBtn' class='w-full py-2 bg-green-600 text-white rounded'>Sign Up</button>
    <button id='toLogin' class='w-full mt-2 py-2 bg-gray-200 rounded'>Already have an account?</button>
  </div>

  <!-- LOGIN -->
  <div id='loginBox' class='hidden'>
    <input id='l_email' class='w-full mb-2 p-2 border rounded' placeholder='Email'>
    <input id='l_pass' class='w-full mb-2 p-2 border rounded' placeholder='Password' type='password'>
    <button id='loginBtn' class='w-full bg-blue-600 text-white py-2 rounded'>Login</button>
    <button id='forgotBtn' class='w-full mt-2 py-2 bg-gray-300 rounded'>Forgot Password?</button>
    <button id='toSignup' class='w-full mt-2 py-2 bg-gray-200 rounded'>Create an Account</button>
  </div>
 </div>
</div>`;

// btn wiring
const SB=document.getElementById('signupBtn');
SB.onclick=async()=>{
  let name=s_name.value.trim();let phone=s_phone.value.trim();let matric=s_matric.value.trim();
  let faculty=s_faculty.value.trim();let dept=s_department.value.trim();let email=s_email.value.trim();let pass=s_pass.value;
  if(!name||!email||!pass)return toast('Fill all required fields');
  const res=await auth.createUserWithEmailAndPassword(email,pass).catch(e=>toast(e.message));
  if(!res)return;

  let photoURL='';
  if(s_pic.files[0]){
    const p=`profile/${res.user.uid}`;
    await storage.ref(p).put(s_pic.files[0]);
    photoURL=await storage.ref(p).getDownloadURL();
  }

  await db.collection('users').doc(res.user.uid).set({
    name,email,phone,matric,faculty,department:dept,level:'100',photoURL,
    settings:{wallpaper:null}
  });
};

toLogin.onclick=()=>{signupBox.classList.add('hidden');loginBox.classList.remove('hidden');}
toSignup.onclick=()=>{loginBox.classList.add('hidden');signupBox.classList.remove('hidden');}

loginBtn.onclick=()=>auth.signInWithEmailAndPassword(l_email.value,l_pass.value).catch(e=>toast(e.message));
forgotBtn.onclick=()=>{
  if(!l_email.value)return toast('Enter email');
  auth.sendPasswordResetEmail(l_email.value).then(()=>toast('Reset mail sent')).catch(e=>toast(e.message));
};
}

// ==============================================================
// MAIN APP
// ==============================================================
auth.onAuthStateChanged(async u=>{
  if(!u)return renderAuth();
  currentUser=u;
  const snap=await db.collection('users').doc(u.uid).get();
  currentProfile=snap.data();
  renderApp();
});

function renderApp(){
app.innerHTML=`
<div class='h-full flex'>

  <!-- SIDEBAR -->
  <aside class='w-80 bg-white border-r p-3 flex flex-col'>
    <div class='flex items-center gap-2 mb-3'>
      <img id='mePic' class='w-10 h-10 rounded-full bg-gray-200'>
      <div>
        <div id='meName' class='font-bold text-sm'></div>
        <div id='meDept' class='text-xs text-gray-500'></div>
      </div>
      <button id='editProfileBtn' class='ml-auto text-blue-600 text-sm'>Edit</button>
    </div>

    <!-- TABS -->
    <div class='flex border-b mb-3'>
      <button id='tabFac' class='flex-1 p-2 text-center font-bold border-b-4 border-blue-600'>Faculties</button>
      <button id='tabDept' class='flex-1 p-2 text-center text-gray-500'>Departments</button>
    </div>

    <div id='facultyList' class='flex-1 overflow-auto'></div>
    <div id='departmentList' class='flex-1 overflow-auto hidden'></div>

    <button id='logoutBtn' class='w-full bg-red-500 text-white py-2 rounded mt-3'>Sign Out</button>
  </aside>

  <!-- CHAT AREA -->
  <div class='flex-1 flex flex-col relative'>
    <header class='p-3 bg-white border-b'>
      <div id='chatTitle' class='font-bold'>Select a contact</div>
      <div id='chatSub' class='text-xs text-gray-500'></div>
    </header>

    <main id='chatArea' class='flex-1 wallpaper overflow-auto p-4'></main>

    <footer class='p-3 bg-white border-t flex items-center gap-2'>
      <emoji-picker id='emojiPick' style='display:none'></emoji-picker>
      <input id='msgBox' class='flex-1 p-2 border rounded' placeholder='Message...'>
      <button id='emojiBtn'>ðŸ˜€</button>
      <input id='fileInput' type='file' class='hidden'>
      <button id='fileBtn'>ðŸ“Ž</button>
      <button id='recordBtn' class='bg-gray-200 px-3 py-1 rounded'>ðŸŽ¤</button>
      <button id='sendBtn' class='bg-blue-600 text-white px-3 py-1 rounded'>Send</button>
    </footer>
  </div>

</div>

<!-- PROFILE EDIT MODAL -->
<div id='profileModal' class='hidden fixed inset-0 bg-black/50 flex items-center justify-center'>
 <div class='bg-white p-6 rounded shadow w-96'>
   <h3 class='text-xl font-bold mb-3'>Edit Profile</h3>
   <input id='e_name' class='w-full p-2 border mb-2 rounded' placeholder='Full Name'>
   <input id='e_phone' class='w-full p-2 border mb-2 rounded' placeholder='Phone'>
   <input id='e_faculty' class='w-full p-2 border mb-2 rounded' placeholder='Faculty'>
   <input id='e_department' class='w-full p-2 border mb-2 rounded' placeholder='Department'>
   <label class='text-sm block mb-2'>Change Profile Pic</label>
   <input id='e_pic' type='file' class='mb-2'>

   <label class='text-sm block mb-2'>Change Wallpaper (preview below)</label>
   <input id='e_wall' type='file' class='mb-2'>
   <div id='wallPreview' class='w-full h-32 bg-gray-200 rounded mb-3'></div>

   <button id='saveProfile' class='w-full bg-blue-600 text-white py-2 rounded'>Save</button>
   <button id='closeProfile' class='w-full mt-2 bg-gray-300 py-2 rounded'>Close</button>
 </div>
</div>
`;

// LOAD PROFILE
mePic.src=currentProfile.photoURL||'https://ui-avatars.com/api/?name='+encodeURIComponent(currentProfile.name||'User');
meName.textContent=currentProfile.name;
meDept.textContent=currentProfile.department+' â€¢ '+currentProfile.faculty;
if(currentProfile.settings.wallpaper)
    chatArea.style.backgroundImage=`url(${currentProfile.settings.wallpaper})`;

// TABS
function loadFaculties(){
  facultyList.innerHTML='';
  db.collection('users').where('level','==','100').get().then(s=>{
    const facMap={};
    s.forEach(d=>{const u=d.data();if(!facMap[u.faculty])facMap[u.faculty]=[];facMap[u.faculty].push({...u,uid:d.id});});
    Object.keys(facMap).forEach(f=>{
      const h=el(`<div class='mb-2'><div class='font-bold mb-1 text-blue-600'>${f}</div></div>`);
      facMap[f].forEach(u=>{
        const item=el(`<div class='p-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2'><img src='${u.photoURL||'https://ui-avatars.com/api/?name='+encodeURIComponent(u.name)}' class='w-8 h-8 rounded'><div><div class='font-semibold'>${u.name}</div><div class='text-xs text-gray-500'>${u.department}</div></div></div>`);
        item.onclick=()=>openChat(u.uid,u);
        h.appendChild(item);
      });
      facultyList.appendChild(h);
    });
  });
}
function loadDepartments(){
  departmentList.innerHTML='';
  db.collection('users').where('level','==','100').get().then(s=>{
    const dMap={};
    s.forEach(d=>{const u=d.data();if(!dMap[u.department])dMap[u.department]=[];dMap[u.department].push({...u,uid:d.id});});
    Object.keys(dMap).forEach(dp=>{
      const h=el(`<div class='mb-2'><div class='font-bold mb-1 text-blue-600'>${dp}</div></div>`);
      dMap[dp].forEach(u=>{
        const item=el(`<div class='p-2 hover:bg-gray-50 cursor-pointer flex items-center gap-2'><img src='${u.photoURL||'https://ui-avatars.com/api/?name='+encodeURIComponent(u.name)}' class='w-8 h-8 rounded'><div><div class='font-semibold'>${u.name}</div><div class='text-xs text-gray-500'>${u.department}</div></div></div>`);
        item.onclick=()=>openChat(u.uid,u);
        h.appendChild(item);
      });
      departmentList.appendChild(h);
    });
  });
}
loadFaculties();

tabFac.onclick=()=>{tabFac.classList.add('border-blue-600');tabDept.classList.remove('border-blue-600');facultyList.classList.remove('hidden');departmentList.classList.add('hidden');loadFaculties();};
tabDept.onclick=()=>{tabDept.classList.add('border-blue-600');tabFac.classList.remove('border-blue-600');departmentList.classList.remove('hidden');facultyList.classList.add('hidden');loadDepartments();};

logoutBtn.onclick=()=>auth.signOut();

// ==============================================================
// EDIT PROFILE
// ==============================================================
editProfileBtn.onclick=()=>{
  profileModal.classList.remove('hidden');
  e_name.value=currentProfile.name;
  e_phone.value=currentProfile.phone;
  e_faculty.value=currentProfile.faculty;
  e_department.value=currentProfile.department;
}

closeProfile.onclick=()=>profileModal.classList.add('hidden');

e_wall.onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=()=>{wallPreview.style.backgroundImage=`url(${r.result})`};r.readAsDataURL(f);
};

saveProfile.onclick=async()=>{
  let name=e_name.value.trim();let phone=e_phone.value.trim();let faculty=e_faculty.value.trim();let department=e_department.value.trim();
  let updates={name,phone,faculty,department};

  if(e_pic.files[0]){
    let p=`profile/${currentUser.uid}`;
    await storage.ref(p).put(e_pic.files[0]);
    updates.photoURL=await storage.ref(p).getDownloadURL();
  }
  if(e_wall.files[0]){
    let p=`wallpapers/${currentUser.uid}`;
    await storage.ref(p).put(e_wall.files[0]);
    let w=await storage.ref(p).getDownloadURL();
    updates['settings.wallpaper']=w;
    chatArea.style.backgroundImage=`url(${w})`;
  }
  await db.collection('users').doc(currentUser.uid).update(updates);
  toast("Profile updated");
  profileModal.classList.add('hidden');
  location.reload();
}

// ==============================================================
// CHAT SYSTEM
// ==============================================================
let unsubMsg=null;
function openChat(uid,profile){
  activeChatUser=uid;
  activeChatId=idGen(currentUser.uid,uid);
  chatTitle.textContent=profile.name;
  chatSub.textContent=profile.department+' â€¢ '+profile.faculty;

  const cref=db.collection('chats').doc(activeChatId);
  cref.get().then(s=>{if(!s.exists)cref.set({members:[currentUser.uid,uid]});});

  if(unsubMsg)unsubMsg();
  unsubMsg=cref.collection('messages').orderBy('createdAt').onSnapshot(s=>{
    chatArea.innerHTML='';
    s.forEach(d=>{
      let m={id:d.id,...d.data()};
      chatArea.appendChild(renderMsg(m));
      cref.collection('messages').doc(m.id).update({deliveredTo:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
      cref.collection('messages').doc(m.id).update({seenBy:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
    });
    chatArea.scrollTop=chatArea.scrollHeight;
  });
}

function renderMsg(m){
  const isMe=m.uid===currentUser.uid;
  const w=el(`<div class='mb-3 flex ${isMe?'justify-end':'justify-start'}'></div>`);
  const b=el(`<div class='p-2 rounded msg-bubble relative ${isMe?'bg-blue-600 text-white':'bg-white'}'></div>`);

  b.oncontextmenu=e=>{e.preventDefault();openReactUI(b,m)};

  if(m.text)b.appendChild(el(`<div>${m.text}</div>`));

  if(m.file){
    if(m.file.type.startsWith('image/')){
      if(m.viewOnce && (!m.openedBy||!m.openedBy.includes(currentUser.uid))){
        const ph=el(`<div class='w-64 h-40 bg-black/80 flex items-center justify-center text-white cursor-pointer rounded'>Tap to view</div>`);
        ph.onclick=()=>openViewOnce(m,ph,b);
        b.appendChild(ph);
      }else b.appendChild(el(`<img src='${m.file.url}' class='max-w-xs rounded'>`));
    }
    else if(m.file.type.startsWith('audio/')){
      b.appendChild(el(`<audio controls src='${m.file.url}'></audio>`));
    }
    else{
      b.appendChild(el(`<a href='${m.file.url}' target='_blank' class='underline'>${m.file.name}</a>`));
    }
  }

  const meta=el(`<div class='text-xs text-gray-200 mt-1'></div>`);
  let time=m.createdAt?.toDate()?.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})||'';
  let del=m.deliveredTo?.length? 'Delivered':'';
  let seen=m.seenBy?.length? 'Seen':'';
  if(isMe)meta.textContent=`${time} â€¢ ${del} ${seen}`;
  else meta.textContent=time;
  b.appendChild(meta);

  w.appendChild(b);
  return w;
}

// VIEW ONCE
async function openViewOnce(m,pl,bubble){
  pl.textContent='Opening...';
  let cref=db.collection('chats').doc(activeChatId);
  let ref=cref.collection('messages').doc(m.id);
  await ref.update({openedBy:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
  pl.remove();
  bubble.appendChild(el(`<img src='${m.file.url}' class='max-w-xs rounded'>`));
}

// REACTIONS
async function openReactUI(b,m){
  Array.from(b.children).forEach(c=>c.classList.add('blur-reaction'));
  const ui=el(`<div class='reaction-ui bg-white rounded shadow flex p-1 gap-1'>${['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ‘'].map(e=>`<button class='text-lg'>${e}</button>`).join('')}</div>`);
  ui.onclick=e=>toggleReact(m.id,e.target.textContent,ui,b);
  b.appendChild(ui);
  setTimeout(()=>document.addEventListener('click',c));
  function c(ev){if(!ui.contains(ev.target)){ui.remove();Array.from(b.children).forEach(c=>c.classList.remove('blur-reaction'));document.removeEventListener('click',c);}}
}
async function toggleReact(msgId,emoji,ui,b){
  const ref=db.collection('chats').doc(activeChatId).collection('messages').doc(msgId);
  const snap=await ref.get();
  let r=snap.data().reactions||{};
  let arr=r[emoji]||[];
  if(arr.includes(currentUser.uid))arr=arr.filter(x=>x!==currentUser.uid);else arr.push(currentUser.uid);
  r[emoji]=arr;
  await ref.update({reactions:r});
}

// SEND
sendBtn.onclick=async()=>{
  if(!activeChatId)return toast('Select user');
  let t=msgBox.value.trim();if(!t)return;
  msgBox.value='';
  await db.collection('chats').doc(activeChatId).collection('messages').add({uid:currentUser.uid,text:t,createdAt:firebase.firestore.FieldValue.serverTimestamp(),deliveredTo:[],seenBy:[],reactions:{}});
};

// FILE
fileBtn.onclick=()=>fileInput.click();
fileInput.onchange=async e=>{
  let f=e.target.files[0];if(!f)return;if(f.size>MAX_UPLOAD)return toast('Too big');
  let path=`files/${activeChatId}/${Date.now()}_${f.name}`;
  let sref=storage.ref(path);
  await sref.put(f);
  let url=await sref.getDownloadURL();
  await db.collection('chats').doc(activeChatId).collection('messages').add({uid:currentUser.uid,file:{url,name:f.name,type:f.type,path},createdAt:firebase.firestore.FieldValue.serverTimestamp(),deliveredTo:[],seenBy:[],reactions:{}});
};

// EMOJI
emojiBtn.onclick=()=>{emojiPick.style.display=emojiPick.style.display==='none'?'block':'none';};
emojiPick.addEventListener('emoji-click',e=>{msgBox.value+=e.detail.unicode;msgBox.focus();});

// RECORD
let recorder=null;let chunks=[];
recordBtn.onmousedown=startRec;recordBtn.onmouseup=stopRec;
async function startRec(){let s=await navigator.mediaDevices.getUserMedia({audio:true});recorder=new MediaRecorder(s);chunks=[];recorder.ondataavailable=e=>chunks.push(e.data);recorder.onstop=sendVoice;recorder.start();toast('Recording...');}
function stopRec(){if(recorder)recorder.stop();}
async function sendVoice(){let blob=new Blob(chunks,{type:'audio/webm'});
let file=new File([blob],`voice_${Date.now()}.webm`);let path=`voice/${activeChatId}/${Date.now()}.webm`;
let sref=storage.ref(path);await sref.put(file);let url=await sref.getDownloadURL();
db.collection('chats').doc(activeChatId).collection('messages').add({uid:currentUser.uid,file:{url,name:file.name,type:file.type,path},createdAt:firebase.firestore.FieldValue.serverTimestamp(),deliveredTo:[],seenBy:[],reactions:{}});
}
}
</script>
</body>
</html>
