<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Edit Chat & Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="logo.fw.jpeg">

<style>
  *{box-sizing:border-box;}
  body{
    margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#020308;color:#fff;overflow:hidden;
  }

  /* ========== INTRO HORROR OVERLAY ========== */
  .intro-overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:#000;display:flex;align-items:center;justify-content:center;
    flex-direction:column;z-index:50;overflow:hidden;
  }
  .fake-chat{
    width:90%;max-width:380px;height:65vh;background:#0b141a;
    border-radius:18px;box-shadow:0 0 30px rgba(0,0,0,.8);
    position:relative;overflow:hidden;border:1px solid #1f2c33;
  }
  .fake-head{
    height:46px;background:linear-gradient(135deg,#075E54,#128C7E);
    display:flex;align-items:center;padding:6px 10px;gap:8px;font-size:13px;
  }
  .fake-head .circle{
    width:26px;height:26px;border-radius:50%;background:#ccc;
  }
  .fake-body{
    position:absolute;top:46px;bottom:0;left:0;right:0;
    padding:8px;font-size:11px;color:#e9edef;display:flex;flex-direction:column;
    gap:5px;
  }
  .fake-msg{
    background:#202c33;border-radius:10px;padding:5px 7px;max-width:70%;
  }
  .fake-msg.me{background:#005c4b;margin-left:auto;}

  /* crack effect */
  .crack{
    position:absolute;top:0;left:0;width:100%;height:100%;
    pointer-events:none;border-radius:18px;opacity:0;mix-blend-mode:screen;
    background:url("https://i.imgur.com/AMZqvQp.png") center/cover no-repeat;
    animation:crackIn 1.6s ease-out forwards;
  }
  @keyframes crackIn{
    0%{opacity:0;transform:scale(1.1);}
    30%{opacity:.6;}
    100%{opacity:.2;transform:scale(1);}
  }

  /* HAHAHA text glitch */
  .laugh-text{
    margin-top:18px;font-size:22px;font-weight:700;letter-spacing:4px;
    color:#ff003c;text-shadow:0 0 10px #ff003c;
    animation:glitch 1.2s infinite;
  }
  @keyframes glitch{
    0%{transform:skewX(0deg);}
    20%{transform:skewX(8deg) translateX(-3px);}
    40%{transform:skewX(-8deg) translateX(3px);}
    60%{transform:skewX(4deg);}
    80%{transform:skewX(-4deg);}
    100%{transform:skewX(0deg);}
  }

  /* worm - extreme but still cartoony */
  .worm{
    position:absolute;width:260px;height:260px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%,#ffe29f,#ffa99f,#ff7e5f,#7f00ff);
    filter:blur(0.5px);box-shadow:0 0 50px rgba(255,0,0,.7);
    transform:scale(0);opacity:0;
    animation:wormEnter 2.3s ease-out forwards 1.5s;
  }
  @keyframes wormEnter{
    0%{transform:scale(0);opacity:0;right:-40%;bottom:-40%;}
    50%{transform:scale(1.3);opacity:1;right:10%;bottom:0;}
    100%{transform:scale(3.2);opacity:1;right:-20%;bottom:-10%;}
  }

  .overlay-fade{
    animation:overlayFadeOut 1.5s ease-in forwards 3.3s;
  }
  @keyframes overlayFadeOut{
    0%{opacity:1;}
    100%{opacity:0;visibility:hidden;}
  }

  /* ========== MAIN SETTINGS UI ========== */
  .settings-wrap{
    position:fixed;top:0;left:0;width:100%;height:100%;
    display:none;align-items:center;justify-content:center;
    background:radial-gradient(circle at top,#1a1f2b,#05060b 60%);
  }
  .panel{
    width:95%;max-width:420px;max-height:90vh;overflow-y:auto;
    background:#0b141a;border-radius:18px;padding:16px;
    box-shadow:0 0 25px rgba(0,0,0,.8);border:1px solid #26343f;
  }
  .section-title{
    font-size:14px;text-transform:uppercase;letter-spacing:1px;
    color:#8aa0b2;margin-top:10px;margin-bottom:6px;
  }

  .profile-row{
    display:flex;align-items:center;gap:12px;margin-top:6px;
  }
  .profile-row img{
    width:60px;height:60px;border-radius:50%;object-fit:cover;
    border:3px solid #00A884;
  }
  input, button, select{
    font-family:inherit;font-size:14px;
  }
  .text-input{
    width:100%;padding:8px;border-radius:8px;border:1px solid #22323d;
    background:#111b21;color:#fff;outline:none;
  }
  .btn{
    margin-top:10px;width:100%;padding:9px;border:none;border-radius:10px;
    cursor:pointer;font-weight:600;
  }
  .btn-save{
    background:#00A884;color:#fff;
  }
  .btn-save:hover{background:#00c39f;}
  .btn-ghost{
    background:#111b21;color:#b1b3b5;border:1px solid #25323c;
  }

  .wallpaper-grid{
    display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;
  }
  .wall-item{
    width:90px;height:60px;border-radius:10px;overflow:hidden;
    border:2px solid transparent;cursor:pointer;position:relative;
  }
  .wall-item img{
    width:100%;height:100%;object-fit:cover;
  }
  .wall-item.active{
    border-color:#00A884;
    box-shadow:0 0 12px rgba(0,168,132,.7);
  }
  .wall-item span{
    position:absolute;bottom:4px;right:4px;font-size:10px;
    background:rgba(0,0,0,.7);padding:1px 5px;border-radius:8px;
  }

  .status-text{
    margin-top:6px;font-size:11px;color:#9aa4ae;
  }
</style>
</head>
<body>

<!-- EXTREME INTRO ANIMATION -->
<div class="intro-overlay" id="introOverlay">
  <div class="fake-chat" id="fakeChat">
    <div class="fake-head">
      <div class="circle"></div>
      <div>
        <div style="font-weight:600;font-size:12px;">Editing Chat…</div>
        <div style="font-size:10px;opacity:.7;">please wait</div>
      </div>
    </div>
    <div class="fake-body">
      <div class="fake-msg">Loading settings…</div>
      <div class="fake-msg me">Applying theme…</div>
      <div class="fake-msg">Syncing profile…</div>
      <div class="fake-msg me" id="glitchLine">Something is wrong.</div>
    </div>
    <div class="crack"></div>
    <div class="worm"></div>
  </div>
  <div class="laugh-text">HA HA HA</div>
</div>

<!-- MAIN SETTINGS -->
<div class="settings-wrap" id="settingsWrap">
  <div class="panel">
    <h3 style="margin:0 0 4px;font-size:17px;">Edit Chat & Profile</h3>
    <p style="margin:0;font-size:11px;color:#9aa4ae;">Customize how your chat looks and how others see you.</p>

    <!-- PROFILE SECTION -->
    <div class="section-title">Profile</div>
    <div class="profile-row">
      <img id="profilePicPreview" src="default.png" alt="Profile">
      <div style="flex:1;">
        <input id="displayName" class="text-input" placeholder="Display name">
        <button class="btn btn-ghost" id="changePfpBtn" type="button">Change profile picture</button>
        <input type="file" id="pfpInput" accept="image/*" style="display:none;">
      </div>
    </div>
    <button class="btn btn-save" id="saveProfileBtn" type="button">Save Profile</button>
    <div id="profileStatus" class="status-text"></div>

    <!-- WALLPAPER SECTION -->
    <div class="section-title">Chat Wallpaper</div>
    <div class="wallpaper-grid" id="wallGrid">
      <!-- preset wallpapers -->
      <div class="wall-item" data-url="https://i.imgur.com/8Km9tLL.png">
        <img src="https://i.imgur.com/8Km9tLL.png">
        <span>Classic</span>
      </div>
      <div class="wall-item" data-url="https://i.imgur.com/Tl8ZBUd.jpeg">
        <img src="https://i.imgur.com/Tl8ZBUd.jpeg">
        <span>Dark Neon</span>
      </div>
      <div class="wall-item" data-url="https://i.imgur.com/cy3rzNR.jpeg">
        <img src="https://i.imgur.com/cy3rzNR.jpeg">
        <span>Abstract</span>
      </div>
    </div>

    <button class="btn btn-ghost" id="customWallBtn" type="button" style="margin-top:8px;">Upload custom wallpaper</button>
    <input type="file" id="wallInput" accept="image/*" style="display:none;">

    <button class="btn btn-save" id="saveWallpaperBtn" type="button">Save Wallpaper</button>
    <div id="wallStatus" class="status-text"></div>

    <div class="status-text" style="margin-top:12px;">
      Tip: chat.html should read your <code>chatWallpaper</code> and use it as the background.
    </div>

    <button class="btn btn-ghost" type="button" style="margin-top:14px;" onclick="history.back()">Back to chat</button>
  </div>
</div>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
  authDomain: "eren-c4b30.firebaseapp.com",
  projectId: "eren-c4b30"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM
const introOverlay = document.getElementById("introOverlay");
const settingsWrap = document.getElementById("settingsWrap");
const profilePicPreview = document.getElementById("profilePicPreview");
const displayNameInput = document.getElementById("displayName");
const changePfpBtn = document.getElementById("changePfpBtn");
const pfpInput = document.getElementById("pfpInput");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileStatus = document.getElementById("profileStatus");

const wallGrid = document.getElementById("wallGrid");
const customWallBtn = document.getElementById("customWallBtn");
const wallInput = document.getElementById("wallInput");
const saveWallpaperBtn = document.getElementById("saveWallpaperBtn");
const wallStatus = document.getElementById("wallStatus");

let currentUser = null;
let selectedWallpaperUrl = null;
let newPfpFile = null;

// ===== HORROR ANIMATION SEQUENCE =====
window.addEventListener("load", ()=>{
  // Little glitch on fake last message
  const glitchLine = document.getElementById("glitchLine");
  setTimeout(()=>glitchLine.textContent="…why are you here?", 700);
  setTimeout(()=>glitchLine.textContent="…you shouldn't be here.", 1200);

  // Start fade out class (worm + overlay exit driven by CSS)
  introOverlay.classList.add("overlay-fade");

  // show main UI after animation
  setTimeout(()=>{
    introOverlay.style.display="none";
    settingsWrap.style.display="flex";
  }, 4800);
});

// ===== ImgBB Upload Helper =====
async function uploadToImgBB(file){
  const form = new FormData();
  form.append("image", file);
  const res = await fetch("https://api.imgbb.com/1/upload?key=efd9e3255bb9ff4053c312897dd157c7",{
    method:"POST",
    body:form
  });
  const data = await res.json();
  if(!data || !data.data || !data.data.url) throw new Error("ImgBB upload failed");
  return data.data.url;
}

// ===== PROFILE & WALLPAPER LOGIC =====
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    profileStatus.textContent = "You must login to edit your profile.";
    wallStatus.textContent = "";
    return;
  }
  currentUser = user;

  try{
    const snap = await getDoc(doc(db,"students",user.uid));
    if(snap.exists()){
      const data = snap.data();
      displayNameInput.value = data.name || "";
      if(data.profilePic) profilePicPreview.src = data.profilePic;
      if(data.chatWallpaper){
        selectedWallpaperUrl = data.chatWallpaper;
        // mark active
        [...wallGrid.querySelectorAll(".wall-item")].forEach(item=>{
          if(item.dataset.url === selectedWallpaperUrl){
            item.classList.add("active");
          }
        });
      }
    }else{
      profileStatus.textContent = "No profile yet. Create one in information.html.";
    }
  }catch(e){
    console.error(e);
    profileStatus.textContent = "Error loading profile.";
  }
});

// handle PFP change
changePfpBtn.onclick = ()=>pfpInput.click();
pfpInput.onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  newPfpFile = file;
  const reader = new FileReader();
  reader.onload = ev => profilePicPreview.src = ev.target.result;
  reader.readAsDataURL(file);
};

// save profile
saveProfileBtn.onclick = async ()=>{
  if(!currentUser) return alert("Login first.");
  profileStatus.textContent = "Saving profile…";

  try{
    let picUrl = profilePicPreview.src;
    if(newPfpFile){
      picUrl = await uploadToImgBB(newPfpFile);
    }

    await setDoc(doc(db,"students",currentUser.uid),{
      uid: currentUser.uid,
      email: currentUser.email,
      name: displayNameInput.value || currentUser.email,
      profilePic: picUrl
    },{merge:true});

    profileStatus.textContent = "Profile updated ✔";
    newPfpFile = null;
  }catch(e){
    console.error(e);
    profileStatus.textContent = "Error saving profile.";
  }
};

// wallpaper preset click
wallGrid.addEventListener("click",(e)=>{
  const item = e.target.closest(".wall-item");
  if(!item) return;
  [...wallGrid.querySelectorAll(".wall-item")].forEach(i=>i.classList.remove("active"));
  item.classList.add("active");
  selectedWallpaperUrl = item.dataset.url;
});

// custom wallpaper upload
customWallBtn.onclick = ()=>wallInput.click();
wallInput.onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  wallStatus.textContent = "Uploading wallpaper…";
  try{
    const url = await uploadToImgBB(file);
    selectedWallpaperUrl = url;
    [...wallGrid.querySelectorAll(".wall-item")].forEach(i=>i.classList.remove("active"));
    wallStatus.textContent = "Custom wallpaper selected ✔";
  }catch(err){
    console.error(err);
    wallStatus.textContent = "Failed to upload wallpaper.";
  }
};

// save wallpaper
saveWallpaperBtn.onclick = async ()=>{
  if(!currentUser) return alert("Login first.");
  if(!selectedWallpaperUrl){
    wallStatus.textContent = "Pick a wallpaper first.";
    return;
  }
  wallStatus.textContent = "Saving wallpaper…";
  try{
    await setDoc(doc(db,"students",currentUser.uid),{
      chatWallpaper: selectedWallpaperUrl
    },{merge:true});
    wallStatus.textContent = "Wallpaper updated ✔";
  }catch(e){
    console.error(e);
    wallStatus.textContent = "Error saving wallpaper.";
  }
};
</script>
</body>
</html>
