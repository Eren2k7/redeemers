<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="logo.fw.jpeg">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUN Directory</title>

<style>
body{font-family:Arial;background:#eef3f8;margin:0;}
header{
  background:#005bff;padding:15px;text-align:center;color:white;
  font-size:20px;position:relative;
}

/* mini profile badge top-right */
.user-badge{
  position:absolute;right:15px;top:8px;
  display:none;align-items:center;gap:8px;font-size:13px;
}
.user-badge img{
  width:32px;height:32px;border-radius:50%;object-fit:cover;
  border:2px solid #fff;
}

.nav{
  display:flex;justify-content:center;background:white;padding:10px;gap:15px;
  border-bottom:2px solid #ccc;
}
.nav button{
  padding:10px 18px;border:none;border-radius:5px;cursor:pointer;font-size:15px;
  background:#d7e5ff;
}
.nav button:hover{background:#005bff;color:white;}

.container{max-width:900px;margin:auto;padding:20px;}
select{width:100%;padding:10px;margin:10px 0;border-radius:5px;border:1px solid #ccc;}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CARD DISPLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.student-card{
  background:white;padding:10px;border-radius:8px;margin:8px 0;display:flex;gap:15px;
  align-items:center;cursor:pointer;border:1px solid #ddd;transition:0.3s;
}
.student-card:hover{background:#eaf1ff;transform:scale(1.02);}

.student-card img{
  width:60px;height:60px;border-radius:50%;object-fit:cover;border:3px solid #005bff;
}

#noResults{font-style:italic;color:#555;margin-top:10px;display:none;}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ POPUP PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#profileModal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.65);display:none;justify-content:center;align-items:center;
}
.modal-box{
  background:white;width:330px;padding:20px;border-radius:10px;text-align:center;
}
.modal-box img{
  width:130px;height:130px;border-radius:50%;object-fit:cover;
  margin-bottom:15px;border:3px solid #005bff;
}
.chat-btn,.close{
  width:100%;padding:10;margin-top:10;border:none;border-radius:5px;font-size:16px;
}
.chat-btn{background:#005bff;color:white;}
.close{background:red;color:white;}
</style>
</head>

<body>

<header>
  üìç RUN Student Directory

  <!-- MINI PROFILE PIC TOP RIGHT -->
  <div class="user-badge" id="userBadge">
    <span id="badgeName"></span>
    <img id="badgePic" src="default.png" alt="You">
  </div>
</header>

<!-- Navigation -->
<div class="nav">
  <button onclick="reload()">Refresh</button>
  <button onclick="window.location.href='chatlist.html'">Chat</button>
</div>

<div class="container">
  
  <!-- FACULTY SELECTION -->
  <select id="facultySelect" onchange="loadDepartments()">
    <option value="">Select Faculty</option>
    <option>Faculty of Natural Sciences</option>
    <option>Faculty of Management Sciences</option>
    <option>Faculty of Built Environment Studies</option>
    <option>Faculty of Humanities</option>
    <option>Faculty of Social Sciences</option>
    <option>Faculty of Engineering</option>
    <option>Faculty of Basic Medical Sciences</option>
    <option>Faculty of Law</option>
  </select>

  <!-- DEPARTMENT LOADS AFTER FACULTY -->
  <select id="departmentSelect" onchange="displayStudents()">
    <option value="">Select Department</option>
  </select>

  <div id="studentList"></div>
  <p id="noResults">No registered students yet.</p>
</div>

<!-- PROFILE POPUP -->
<div id="profileModal">
  <div class="modal-box">
    <img id="pPic">
    <h3 id="pName"></h3>

    <p><b>Age:</b> <span id="pAge"></span></p>
    <p><b>Complexion:</b> <span id="pComplexion"></span></p>
    <p><b>Department:</b> <span id="pDept"></span></p>
    <p><b>Faculty:</b> <span id="pFaculty"></span></p>
    <p id="pAbout"></p>

    <button class="chat-btn" onclick="startChat()">Message</button>
    <button class="close" onclick="closeProfile()">Close</button>
  </div>
</div>


<!-- FIREBASE LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getFirestore, collection, getDocs, getDoc, doc 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
  authDomain: "eren-c4b30.firebaseapp.com",
  projectId: "eren-c4b30"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let users = [];
let selectedUser=null;


/* LOAD USERS FROM FIRESTORE (dedupe by email) */
async function fetchUsers(){
  users=[];
  const snap = await getDocs(collection(db,"students"));

  const byEmail = {}; // to avoid double profiles from same email
  snap.forEach(d => {
    const data = { uid:d.id, ...d.data() };
    if(data.email){
      byEmail[data.email] = data;  // last one wins
    }else{
      // no email field, just push raw
      users.push(data);
    }
  });

  // add unique email profiles
  users = users.concat(Object.values(byEmail));
}
await fetchUsers();


/* FACULTY ‚Üí DEPARTMENT MAPPING (already good) */
const depts={
"Faculty of Natural Sciences":["Computer Science","Applied Geophysics","Environmental Management & Toxicology","Geology","Industrial Chemistry","Microbiology","Meteorology","Physics with Electronics","Mathematics & Statistics"],
"Faculty of Management Sciences":["Accounting","Banking & Finance","Business Administration","Insurance","Marketing","Public Administration","Transport Management"],
"Faculty of Built Environment Studies":["Architecture","Building Technology","Estate Management","Quantity Surveying","Urban & Regional Planning","Surveying & Geoinformatics"],
"Faculty of Humanities":["Christian Religious Studies","English","French","History & International Studies","Philosophy","Theatre Arts"],
"Faculty of Social Sciences":["Economics","Mass Communication","Psychology","Political Science","Sociology","Tourism","Social Work"],
"Faculty of Engineering":["Civil Engineering","Computer Engineering","Electrical & Electronics Engineering","Mechanical Engineering"],
"Faculty of Basic Medical Sciences":["Biochemistry","Human Anatomy","Human Physiology","Nursing","Physiotherapy"],
"Faculty of Law":["Law"]
};


/* LOAD DEPARTMENTS WHEN FACULTY SELECTED */
window.loadDepartments=function(){
  const fac=document.getElementById("facultySelect").value;
  const dep=document.getElementById("departmentSelect");
  dep.innerHTML=`<option value="">Select Department</option>`;

  (depts[fac]||[]).forEach(d=>dep.innerHTML+=`<option>${d}</option>`);

  displayStudents();
}


/* DISPLAY USERS MATCHING FACULTY + DEPT */
window.displayStudents=function(){
  const fac=document.getElementById("facultySelect").value;
  const dep=document.getElementById("departmentSelect").value;
  const box=document.getElementById("studentList");
  box.innerHTML="";

  const list=users.filter(s=>
    (!fac || s.faculty==fac) && (!dep || s.department==dep)
  );

  if(list.length===0){
    document.getElementById("noResults").style.display="block";
    return;
  }
  document.getElementById("noResults").style.display="none";

  list.forEach(s=>{
    box.innerHTML+=`
      <div class="student-card" onclick='openProfile(${JSON.stringify(s)})'>
        <img src="${s.profilePic || 'default.png'}">
        <div><b>${s.name || ''}</b><br>${s.department || ''}</div>
      </div>`;
  });
}


/* OPEN PROFILE POPUP */
window.openProfile=function(s){
  selectedUser=s;
  document.getElementById("profileModal").style.display="flex";
  document.getElementById("pPic").src=s.profilePic || 'default.png';
  document.getElementById("pName").textContent=s.name || "";
  document.getElementById("pAge").textContent=s.age || "";
  document.getElementById("pComplexion").textContent=s.complexion || "";
  document.getElementById("pDept").textContent=s.department || "";
  document.getElementById("pFaculty").textContent=s.faculty || "";
  document.getElementById("pAbout").textContent=s.about || "";
}


/* CLOSE POPUP */
window.closeProfile=()=>document.getElementById("profileModal").style.display="none";


/* CHAT REDIRECT */
window.startChat=function(){
  if(!selectedUser) return;
  window.location.href="chatlist.html?user="+selectedUser.uid;
}

window.reload=()=>location.reload();
displayStudents();


/* MINI PROFILE BADGE (TOP RIGHT) */
onAuthStateChanged(auth, async (user)=>{
  if(!user) return;
  try{
    const snap = await getDoc(doc(db,"students",user.uid));
    if(snap.exists()){
      const data = snap.data();
      const badge = document.getElementById("userBadge");
      document.getElementById("badgeName").textContent = data.name || user.email;
      document.getElementById("badgePic").src = data.profilePic || "default.png";
      badge.style.display = "flex";
    }
  }catch(e){
    console.error(e);
  }
});
</script>

</body>
</html>
