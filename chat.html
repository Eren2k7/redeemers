<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RUN Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="logo.fw.jpeg">

<style>
  *{box-sizing:border-box;}
  body{
    margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#0b141a;color:#fff;display:flex;justify-content:center;align-items:center;
    height:100vh;
  }
  .chat-shell{
    width:100%;max-width:420px;height:100vh;max-height:800px;
    background:#111b21;border-radius:0;display:flex;flex-direction:column;
    box-shadow:0 0 18px rgba(0,0,0,.5);
  }

  /* HEADER â€“ iPhone / WhatsApp style */
  .chat-header{
    padding:10px;display:flex;align-items:center;gap:10px;
    background:linear-gradient(135deg,#075E54,#128C7E);
    color:#fff;position:relative;
  }
  .back-btn{
    border:none;background:transparent;color:white;font-size:20px;cursor:pointer;
  }
  .chat-avatar{
    width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #fff;
  }
  .head-main{
    display:flex;flex-direction:column;align-items:flex-start;flex:1;
  }
  .head-name{font-weight:600;font-size:15px;}
  .head-sub{font-size:11px;opacity:.85;}

  /* mini self profile top-right */
  .self-mini{
    position:absolute;right:10px;top:6px;display:flex;align-items:center;gap:6px;
    font-size:11px;opacity:.9;
  }
  .self-mini img{
    width:26px;height:26px;border-radius:50%;object-fit:cover;border:2px solid #fff;
  }

  /* MESSAGES AREA */
  .messages{
    flex:1;padding:10px;background:url('https://i.imgur.com/8Km9tLL.png') repeat;
    background-size:200px auto;overflow-y:auto;scroll-behavior:smooth;
  }
  .msg-row{
    display:flex;margin-bottom:6px;
  }
  .msg-row.me{justify-content:flex-end;}
  .msg-row.them{justify-content:flex-start;}

  .bubble{
    max-width:75%;padding:7px 9px;border-radius:14px;font-size:13px;
    position:relative;animation:slideIn .2s ease-out;
    word-wrap:break-word;white-space:pre-wrap;
  }
  .me .bubble{
    background:#005c4b;color:#fff;border-bottom-right-radius:2px;
  }
  .them .bubble{
    background:#202c33;color:#e9edef;border-bottom-left-radius:2px;
  }
  .time{
    font-size:9px;opacity:.7;margin-top:3px;text-align:right;
  }

  /* emoji-only messages bigger */
  .emoji-only{
    font-size:28px;line-height:1.2;
    animation:popEmoji .4s ease-out;
  }
  @keyframes popEmoji{
    0%{transform:scale(.4);opacity:0;}
    60%{transform:scale(1.2);opacity:1;}
    100%{transform:scale(1);}
  }
  @keyframes slideIn{
    from{transform:translateY(8px);opacity:0;}
    to{transform:translateY(0);opacity:1;}
  }

  /* image message */
  .msg-image{
    max-width:210px;border-radius:12px;margin-top:4px;cursor:pointer;
    display:block;
  }
  .view-once-tag{
    font-size:9px;opacity:.8;margin-top:2px;
  }

  /* TYPING */
  .typing-bar{
    min-height:18px;font-size:11px;color:#b1b3b5;padding:0 12px 4px;
  }

  /* INPUT AREA */
  .input-area{
    padding:6px 8px;display:flex;align-items:flex-end;gap:6px;
    background:#202c33;
  }
  .icon-btn{
    border:none;background:transparent;color:#aebac1;font-size:20px;cursor:pointer;
  }
  .text-wrap{flex:1;display:flex;align-items:center;background:#111b21;border-radius:18px;padding:4px 8px;}
  .text-wrap textarea{
    background:transparent;border:none;resize:none;flex:1;color:#fff;
    max-height:70px;min-height:20px;font-size:14px;outline:none;
  }
  .attach-input{display:none;}
  .send-btn{
    border:none;background:#00A884;border-radius:50%;width:34px;height:34px;
    display:flex;align-items:center;justify-content:center;color:white;font-size:18px;
    cursor:pointer;
  }

  /* EMOJI PICKER */
  .emoji-panel{
    position:absolute;bottom:60px;left:10px;right:10px;
    background:#202c33;border-radius:12px;padding:8px;display:none;
    box-shadow:0 0 15px rgba(0,0,0,.6);
  }
  .emoji-search{
    width:100%;padding:5px 8px;font-size:13px;border-radius:8px;border:none;
    outline:none;margin-bottom:6px;background:#111b21;color:#fff;
  }
  .emoji-grid{
    max-height:160px;overflow-y:auto;display:flex;flex-wrap:wrap;gap:4px;
  }
  .emoji-item{
    width:30px;height:30px;display:flex;align-items:center;justify-content:center;
    font-size:20px;cursor:pointer;border-radius:6px;transition:.15s;
  }
  .emoji-item:hover{
    transform:scale(1.2);
    background:rgba(255,255,255,.06);
  }

  /* FULLSCREEN IMAGE VIEW */
  .img-viewer{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;
    flex-direction:column;z-index:50;
  }
  .img-viewer img{
    max-width:90%;max-height:80%;border-radius:14px;
  }
  .img-viewer button{
    margin-top:10px;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;
  }

  .top-tools{
    position:absolute;right:8px;bottom:60px;display:flex;flex-direction:column;gap:6px;
  }
  .view-once-toggle{
    display:flex;align-items:center;gap:4px;font-size:11px;color:#ccc;
  }
  .view-once-toggle input{transform:scale(1.1);}
  .edit-btn{
    border:none;background:#111b21;color:#ccc;padding:4px 8px;font-size:11px;
    border-radius:10px;cursor:pointer;
  }
</style>
</head>

<body>
<div class="chat-shell">

  <!-- HEADER -->
  <div class="chat-header">
    <button class="back-btn" onclick="history.back()">â€¹</button>
    <img id="otherAvatar" class="chat-avatar" src="default.png">
    <div class="head-main">
      <div class="head-name" id="otherName">Chat</div>
      <div class="head-sub" id="statusText">connectingâ€¦</div>
    </div>

    <!-- your mini profile -->
    <div class="self-mini" id="selfMini" style="display:none;">
      <span id="selfNameMini"></span>
      <img id="selfPicMini" src="default.png">
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="messages" id="messages"></div>

  <!-- typing indicator -->
  <div class="typing-bar" id="typingBar"></div>

  <!-- EMOJI PANEL -->
  <div class="emoji-panel" id="emojiPanel">
    <input id="emojiSearch" class="emoji-search" placeholder="Search emoji...">
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>

  <!-- full image viewer -->
  <div class="img-viewer" id="imgViewer">
    <img id="viewerImg">
    <button onclick="closeImageViewer()">Close</button>
  </div>

  <!-- INPUT -->
  <div class="input-area">
    <button class="icon-btn" id="emojiToggle">ðŸ˜Š</button>

    <div class="text-wrap">
      <textarea id="msgInput" rows="1" placeholder="Message"></textarea>
    </div>

    <input type="file" id="attachInput" class="attach-input" accept="image/*">
    <button class="icon-btn" onclick="document.getElementById('attachInput').click()">ðŸ“Ž</button>

    <button class="send-btn" id="sendBtn">âž¤</button>
  </div>

  <!-- view once + edit tools -->
  <div class="top-tools">
    <label class="view-once-toggle">
      <input type="checkbox" id="viewOnceCheckbox">
      <span>View once</span>
    </label>
    <button class="edit-btn" onclick="window.location.href='edit.html'">Edit chat / profile</button>
  </div>
</div>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
  authDomain: "eren-c4b30.firebaseapp.com",
  projectId: "eren-c4b30"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM refs
const messagesDiv = document.getElementById("messages");
const typingBar = document.getElementById("typingBar");
const statusText = document.getElementById("statusText");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const emojiPanel = document.getElementById("emojiPanel");
const emojiToggle = document.getElementById("emojiToggle");
const emojiGrid = document.getElementById("emojiGrid");
const emojiSearch = document.getElementById("emojiSearch");
const attachInput = document.getElementById("attachInput");
const viewOnceCheckbox = document.getElementById("viewOnceCheckbox");
const otherAvatar = document.getElementById("otherAvatar");
const otherNameEl = document.getElementById("otherName");
const selfMini = document.getElementById("selfMini");
const selfNameMini = document.getElementById("selfNameMini");
const selfPicMini = document.getElementById("selfPicMini");
const imgViewer = document.getElementById("imgViewer");
const viewerImg = document.getElementById("viewerImg");

// other user from URL
const params = new URLSearchParams(window.location.search);
const otherUid = params.get("user");

let currentUser = null;
let chatId = null;
let chatDocRef = null;
let typingTimeout = null;

// basic emoji list
const EMOJIS = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜","ðŸ˜˜","ðŸ˜œ","ðŸ¤”","ðŸ¤¤","ðŸ˜´","ðŸ˜Ž","ðŸ˜¢","ðŸ˜­","ðŸ˜¡","ðŸ¤¯","ðŸ‘","ðŸ‘Ž","ðŸ‘","ðŸ™","ðŸ”¥","ðŸ’€","â¤ï¸","ðŸ’™","ðŸ’š","ðŸ’›","ðŸ’œ","ðŸ–¤","âœ¨","â­","ðŸŒ™","âš¡","ðŸŽ‰","ðŸŽŠ","ðŸ˜ˆ","ðŸ‘€","ðŸ¤","ðŸ’¯"];

// build emoji grid
function renderEmojis(filter=""){
  emojiGrid.innerHTML = "";
  EMOJIS.filter(e => e.includes(filter)).forEach(e=>{
    const item = document.createElement("div");
    item.className = "emoji-item";
    item.textContent = e;
    item.onclick = ()=>{
      msgInput.value += e;
      msgInput.focus();
    };
    emojiGrid.appendChild(item);
  });
}
renderEmojis();

emojiToggle.onclick = ()=>{
  emojiPanel.style.display = (emojiPanel.style.display==="block" ? "none" : "block");
};
emojiSearch.oninput = ()=>renderEmojis(emojiSearch.value.trim());

window.closeImageViewer = function(){
  imgViewer.style.display = "none";
};

// ImgBB upload
async function uploadImage(file){
  const form = new FormData();
  form.append("image", file);
  const res = await fetch("https://api.imgbb.com/1/upload?key=efd9e3255bb9ff4053c312897dd157c7",{
    method:"POST",
    body:form
  });
  const data = await res.json();
  return data.data.url;
}

// build consistent chat id
function getChatId(uid1, uid2){
  return [uid1, uid2].sort().join("_");
}

// render one message
function renderMessage(msg){
  const row = document.createElement("div");
  const isMe = msg.senderId === currentUser.uid;
  row.className = "msg-row " + (isMe ? "me" : "them");

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  let hasText = !!msg.text;
  let text = msg.text || "";

  // emoji-only styling
  if(text && /^[\s\p{Emoji_Presentation}\p{Extended_Pictographic}]+$/u.test(text.trim())){
    bubble.classList.add("emoji-only");
  }

  if(msg.imageUrl){
    const img = document.createElement("img");
    img.src = msg.imageUrl;
    img.className = "msg-image";
    img.onclick = async ()=>{
      // view-once logic
      if(msg.viewOnce && !isMe && !msg.viewedBy?.includes(currentUser.uid)){
        imgViewer.style.display = "flex";
        viewerImg.src = msg.imageUrl;

        // mark as viewed (best-effort)
        try{
          await updateDoc(doc(db, "chats", chatId, "messages", msg.id), {
            viewedBy: (msg.viewedBy || []).concat(currentUser.uid)
          });
        }catch(e){console.error(e);}
      }else if(msg.viewOnce && !isMe){
        // already viewed - show note
        alert("This photo is view once and is no longer available.");
      }else{
        imgViewer.style.display = "flex";
        viewerImg.src = msg.imageUrl;
      }
    };
    bubble.appendChild(img);

    // view once label
    if(msg.viewOnce){
      const tag = document.createElement("div");
      tag.className = "view-once-tag";
      const seen = msg.viewedBy && msg.viewedBy.includes(currentUser.uid);
      tag.textContent = seen && !isMe ? "Opened â€¢ view once" : "View once photo";
      bubble.appendChild(tag);
    }
  }

  if(hasText){
    const textEl = document.createElement("div");
    textEl.textContent = text;
    bubble.appendChild(textEl);
  }

  const time = document.createElement("div");
  time.className = "time";
  if(msg.createdAt && msg.createdAt.toDate){
    const d = msg.createdAt.toDate();
    time.textContent = d.getHours().toString().padStart(2,"0") + ":" +
                       d.getMinutes().toString().padStart(2,"0");
  }
  bubble.appendChild(time);

  row.appendChild(bubble);
  messagesDiv.appendChild(row);
}

// live messages listener
function subscribeMessages(){
  const msgsRef = collection(db, "chats", chatId, "messages");
  const q = query(msgsRef, orderBy("createdAt","asc"));
  onSnapshot(q, snapshot=>{
    messagesDiv.innerHTML = "";
    snapshot.forEach(docSnap=>{
      const msg = { id:docSnap.id, ...docSnap.data() };
      renderMessage(msg);

      // notifications if message from other user
      if(currentUser && msg.senderId !== currentUser.uid){
        if(document.visibilityState === "hidden" && Notification.permission==="granted"){
          new Notification(msg.senderName || "New message", {
            body: msg.text || "Photo",
          });
        }
      }
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// typing indicator
function setupTyping(){
  const chatRef = doc(db,"chats",chatId);
  onSnapshot(chatRef, snap=>{
    const data = snap.data() || {};
    const otherTyping = data["typing_"+otherUid];
    if(otherTyping){
      typingBar.textContent = "typingâ€¦";
    }else{
      typingBar.textContent = "";
    }
  });

  msgInput.addEventListener("input", async ()=>{
    if(!currentUser) return;
    try{
      await updateDoc(chatRef,{["typing_"+currentUser.uid]:true});
    }catch{
      await setDoc(chatRef,{["typing_"+currentUser.uid]:true},{merge:true});
    }

    if(typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(async ()=>{
      try{
        await updateDoc(chatRef,{["typing_"+currentUser.uid]:false});
      }catch{}
    },1500);
  });
}

// send text or text+image
async function sendMessage({text="", imageUrl=null, viewOnce=false}){
  if(!currentUser || !chatId) return;
  if(!text && !imageUrl) return;

  const msgsRef = collection(db,"chats",chatId,"messages");
  await addDoc(msgsRef,{
    senderId: currentUser.uid,
    senderName: currentUser.displayName || "",
    text: text,
    imageUrl: imageUrl,
    viewOnce: viewOnce,
    viewedBy: [],
    createdAt: serverTimestamp()
  });

  msgInput.value = "";
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// input send handlers
sendBtn.onclick = async ()=>{
  const text = msgInput.value.trim();
  const viewOnce = viewOnceCheckbox.checked;
  if(!text) return;
  await sendMessage({text, viewOnce});
};

msgInput.addEventListener("keydown", async (e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

// attach image
attachInput.addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = await uploadImage(file);
  const viewOnce = viewOnceCheckbox.checked;
  await sendMessage({imageUrl:url, viewOnce});
  attachInput.value = "";
});

// notification permission
if("Notification" in window && Notification.permission==="default"){
  Notification.requestPermission();
}

// AUTH + CHAT INIT
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    statusText.textContent = "Please login first.";
    return;
  }
  currentUser = user;


  
  // load your profile
  try{
    const mySnap = await getDoc(doc(db,"students",user.uid));
    if(mySnap.exists()){
      const me = mySnap.data();
      selfNameMini.textContent = me.name || user.email;
      selfPicMini.src = me.profilePic || "default.png";
      selfMini.style.display = "flex";
    }
  }catch(e){console.error(e);}

  if(!otherUid){
    statusText.textContent = "No chat user selected.";
    return;
  }

  // load other user profile
  const otherSnap = await getDoc(doc(db,"students",otherUid));
  if(otherSnap.exists()){
    const oth = otherSnap.data();
    otherNameEl.textContent = oth.name || "Student";
    otherAvatar.src = oth.profilePic || "default.png";
    statusText.textContent = oth.department ? (oth.department+" â€¢ "+oth.faculty) : "Online";
  }else{
    otherNameEl.textContent = "Unknown user";
  }

  // set up chat
  chatId = getChatId(currentUser.uid, otherUid);
  chatDocRef = doc(db,"chats",chatId);
  await setDoc(chatDocRef,{
    users:[currentUser.uid, otherUid]
  },{merge:true});

  setupTyping();
  subscribeMessages();
});
</script>
</body>
</html>
