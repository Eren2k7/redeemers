<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RUN Chat</title>

<style>
body {
  margin: 0;
  color: white;
  font-family: Arial;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* HEADER */
.chat-header {
  background: #075E54;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  font-size: 17px;
}
.chat-header img {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #00ffc6;
}
.menu-dots {
  position: absolute;
  right: 10px;
  top: 6px;
  font-size: 26px;
  cursor: pointer;
}
.dropdown-menu {
  display: none;
  position: absolute;
  right: 10px;
  top: 44px;
  background: #112026;
  border-radius: 10px;
  width: 150px;
  padding: 6px;
  box-shadow: 0 0 12px black;
}
.dropdown-menu button {
  width: 100%;
  background: none;
  border: none;
  color: white;
  text-align: left;
  padding: 9px;
  font-size: 14px;
  cursor: pointer;
}
.dropdown-menu button:hover {
  background: #004f42;
}

/* CHAT WINDOW */
.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background-size: cover;
  background-position: center;
}

/* Messages */
.msg {
  max-width: 70%;
  padding: 9px;
  margin: 6px 0;
  border-radius: 14px;
  font-size: 14px;
  animation: pop 0.2s;
}
.me {
  background: #075E54;
  margin-left: auto;
}
.them {
  background: #1f2b32;
}
@keyframes pop {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Input bar */
.chat-input {
  display: flex;
  padding: 10px;
  background: #0f1a20;
  align-items: center;
  gap: 10px;
}
.chat-input input {
  flex: 1;
  padding: 11px;
  border-radius: 35px;
  border: none;
  background: #152026;
  color: white;
  font-size: 14px;
}
.sendBtn {
  background: #00ffc6;
  border: none;
  padding: 10px;
  border-radius: 50%;
  cursor: pointer;
}
.file-btn,
.emoji-btn {
  cursor: pointer;
  font-size: 22px;
}

#emojiPanel {
  display: none;
  position: absolute;
  bottom: 75px;
  left: 10px;
  width: 230px;
  height: 200px;
  background: #112026;
  border-radius: 10px;
  padding: 8px;
  overflow-y: auto;
}
.emoji {
  font-size: 24px;
  padding: 5px;
  cursor: pointer;
}
.emoji:hover {
  transform: scale(1.4);
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="chat-header">
  <img id="pic">
  <span id="nameTxt">Chat</span>

  <div id="menuDots" class="menu-dots">â‹®</div>
  <div id="dropdownMenu" class="dropdown-menu">
    <button onclick="location.href='edit.html'">Edit Profile</button>
    <button onclick="location.href='chatlist.html'">Chat List</button>
    <button onclick="history.back()">Back</button>
  </div>
</div>

<!-- CHAT DISPLAY -->
<div class="chat-body" id="chatBox"></div>

<!-- EMOJI -->
<div id="emojiPanel"></div>

<!-- INPUT -->
<div class="chat-input">
  <span class="emoji-btn" onclick="toggleEmoji()">ðŸ˜€</span>
  <input id="msgInput" placeholder="Message...">
  <input type="file" id="imgSend" accept="image/*" hidden>
  <span class="file-btn" onclick="imgSend.click()">ðŸ“Ž</span>
  <button class="sendBtn" onclick="sendMsg()">âž¤</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, onSnapshot as onDocSnapshot }
from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

/* firebase */
const app = initializeApp({
  apiKey: "AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
  authDomain: "eren-c4b30.firebaseapp.com",
  projectId: "eren-c4b30",
  storageBucket: "eren-c4b30.appspot.com"
});
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let me = null, other = null, room = null;

/* START CHAT */
onAuthStateChanged(async user => {
  me = user.uid;

  const url = new URLSearchParams(location.search);
  other = url.get("user");
  room = [me, other].sort().join("_");

  let u = await getDoc(doc(db, "students", other));
  let s = u.data();
  pic.src = s.profilePic;
  nameTxt.textContent = s.name;

  // Listen for wallpaper changes in real-time
  onDocSnapshot(doc(db, "students", me), (snapshot) => {
    const data = snapshot.data();
    document.querySelector(".chat-body").style.backgroundImage = `url('${data.wallpaper || ""}')`;
  });

  loadMsgs();
});

/* LIVE CHAT STREAM */
function loadMsgs() {
  const q = query(collection(db, "chats", room, "messages"), orderBy("time"));
  onSnapshot(q, s => {
    chatBox.innerHTML = "";
    s.forEach(x => {
      let d = x.data(), mine = d.from == me;
      chatBox.innerHTML += `
      <div class="msg ${mine ? 'me' : 'them'}">
      ${d.text || `<img src='${d.image}' width='180'>`}
      </div>`;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

/* SEND MESSAGE */
window.sendMsg = async () => {
  let t = msgInput.value.trim();
  if (!t) return;
  msgInput.value = "";
  await addDoc(collection(db, "chats", room, "messages"), {
    text: t,
    from: me,
    to: other,
    time: Date.now()
  });
};

/* SEND IMAGE */
imgSend.onchange = async () => {
  let f = imgSend.files[0];
  let r = ref(storage, "chatImgs/" + Date.now());
  await uploadBytes(r, f);
  let url = await getDownloadURL(r);

  await addDoc(collection(db, "chats", room, "messages"), {
    image: url,
    from: me,
    to: other,
    time: Date.now()
  });
};

/* EMOJI */
function toggleEmoji() {
  emojiPanel.style.display = emojiPanel.style.display == "block" ? "none" : "block";
}
let e = "";
for (let i = 128512; i <= 128592; i++) e += `<span class='emoji' onclick="msgInput.value+=String.fromCodePoint(${i})">&#${i};</span>`;
emojiPanel.innerHTML = e;

/* MENU */
menuDots.onclick = () => dropdownMenu.style.display = dropdownMenu.style.display == "block" ? "none" : "block";
</script>

</body>
</html>