<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Redeemerâ€™s Profile Setup</title>

<style>
  body{
    background:#0d1126;color:white;font-family:Arial, sans-serif;
    margin:0;padding:20px;text-align:center;
  }
  .card{
    width:410px;margin:auto;background:#12182f;padding:25px;border-radius:12px;
    box-shadow:0 0 20px rgba(0,255,255,.2);
  }
  h2{color:#00eaff;margin-bottom:12px;}

  select,input,textarea{
    width:95%;margin-top:10px;padding:10px;background:#1a2548;border:1px solid #00eaff;
    border-radius:6px;color:white;font-size:15px;
  }
  button{
    width:95%;margin-top:18px;padding:12px;background:#00eaff;color:black;font-weight:600;
    border:none;border-radius:6px;font-size:16px;cursor:pointer;transition:.3s;
  }
  button:hover{background:#11ffee;}

  #uploadStatus{
    display:none;margin-top:12px;padding:10px;border-radius:6px;font-size:14px;
    background:#08101f;border:1px solid #00eaff;
    animation:fadeIn .4s;
  }
  @keyframes fadeIn{0%{opacity:0}100%{opacity:1}}

  .successGlow{
    animation:glow .8s ease-out 1;
  }
  @keyframes glow{
    0%{box-shadow:0 0 0px #00ffbf;}
    50%{box-shadow:0 0 25px #00ffbf;}
    100%{box-shadow:0 0 6px #00ffbf;}
  }
</style>
</head>

<body>
<div class="card" id="formCard">
  <h2>Complete Your Profile</h2>

  <input id="name" placeholder="Full Name">

  <!-- AGE DROPDOWN -->
  <select id="age">
    <option value="">Select Age</option>
    <script>
      for(let i=15;i<=40;i++){document.write(`<option value="${i}">${i}</option>`);}
    </script>
  </select>

  <input id="complexion" placeholder="Complexion">

  <!-- ðŸ”¥ FACULTIES (SYNCED WITH DIRECTORY) -->
  <select id="faculty" onchange="loadDepartments()">
    <option value="">Select Faculty</option>
    <option value="Faculty of Natural Sciences">Faculty of Natural Sciences</option>
    <option value="Faculty of Management Sciences">Faculty of Management Sciences</option>
    <option value="Faculty of Built Environment Studies">Faculty of Built Environment Studies</option>
    <option value="Faculty of Humanities">Faculty of Humanities</option>
    <option value="Faculty of Social Sciences">Faculty of Social Sciences</option>
    <option value="Faculty of Engineering">Faculty of Engineering</option>
    <option value="Faculty of Basic Medical Sciences">Faculty of Basic Medical Sciences</option>
    <option value="Faculty of Law">Faculty of Law</option>
  </select>

  <select id="department">
    <option value="">Select Department</option>
  </select>

  <textarea id="about" rows="4" placeholder="Write about yourself..."></textarea>

  <label style="display:block;margin-top:10px;">Upload Profile Picture</label>
  <input type="file" id="profilePic" accept="image/*">

  <div id="uploadStatus"></div>

  <button id="saveBtn">Save Profile</button>
</div>



<!--------- FIREBASE + IMGBB ---------->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
  authDomain:"eren-c4b30.firebaseapp.com",
  projectId:"eren-c4b30"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


/* ðŸ”¥ Faculty â†’ Departments (SYNCED WITH DIRECTORY) */
const departmentData = {
  "Faculty of Natural Sciences":[
    "Computer Science","Applied Geophysics","Environmental Management & Toxicology","Geology",
    "Industrial Chemistry","Microbiology","Meteorology","Physics with Electronics",
    "Mathematics & Statistics"
  ],
  "Faculty of Management Sciences":[
    "Accounting","Banking & Finance","Business Administration","Insurance","Marketing",
    "Public Administration","Transport Management"
  ],
  "Faculty of Built Environment Studies":[
    "Architecture","Building Technology","Estate Management","Quantity Surveying",
    "Urban & Regional Planning","Surveying & Geoinformatics"
  ],
  "Faculty of Humanities":[
    "Christian Religious Studies","English","French","History & International Studies",
    "Philosophy","Theatre Arts"
  ],
  "Faculty of Social Sciences":[
    "Economics","Mass Communication","Psychology","Political Science","Sociology",
    "Tourism","Social Work"
  ],
  "Faculty of Engineering":[
    "Civil Engineering","Computer Engineering","Electrical & Electronics Engineering",
    "Mechanical Engineering"
  ],
  "Faculty of Basic Medical Sciences":[
    "Biochemistry","Human Anatomy","Human Physiology","Nursing","Physiotherapy"
  ],
  "Faculty of Law":["Law"]
};

window.loadDepartments = function(){
  const fac = document.getElementById("faculty").value;
  const depSelect = document.getElementById("department");
  depSelect.innerHTML = `<option value="">Select Department</option>`;
  (departmentData[fac] || []).forEach(dep=>{
    const opt=document.createElement("option");
    opt.value=dep; opt.textContent=dep;
    depSelect.appendChild(opt);
  });
};


/* ðŸ”¥ ImgBB Upload with animation */
async function uploadToImgBB(file){
  const box = document.getElementById("uploadStatus");
  box.style.display = "block";
  box.textContent = "â³ Uploading picture...";

  const form = new FormData();
  form.append("image", file);

  const res = await fetch("https://api.imgbb.com/1/upload?key=efd9e3255bb9ff4053c312897dd157c7",{
    method:"POST",
    body:form
  });

  const data = await res.json();
  if(!data || !data.data || !data.data.url){
    box.textContent = "âŒ Upload failed. Try again.";
    throw new Error("ImgBB upload failed");
  }

  box.textContent = "âœ” Upload complete!";
  document.getElementById("formCard").classList.add("successGlow");
  return data.data.url;
}


document.getElementById("saveBtn").onclick = async () => {
  const user = auth.currentUser;
  if (!user) return alert("Login first!");

  const pic = document.getElementById("profilePic").files[0];
  if (!pic) return alert("Select profile picture!");

  // upload to ImgBB (your existing function)
  const imageURL = await uploadToImgBB(pic);

  // ðŸ”¥ check if this email already has a profile
  const studentsRef = collection(db, "students");
  const q = query(studentsRef, where("email", "==", user.email));
  const snap = await getDocs(q);

  let docId = user.uid; // default to current uid
  if (!snap.empty) {
    // profile already exists â†’ reuse that doc id
    docId = snap.docs[0].id;
  }

  await setDoc(doc(db, "students", docId), {
    uid: docId,
    name: document.getElementById("name").value,
    age: document.getElementById("age").value,
    complexion: document.getElementById("complexion").value,
    faculty: document.getElementById("faculty").value,
    department: document.getElementById("department").value,
    about: document.getElementById("about").value,
    profilePic: imageURL,
    email: user.email
  });

  alert("ðŸŽ‰ Profile Saved Successfully");
  location.href = "directory.html";
};



/* ðŸ”’ OLD USERS SKIP THIS PAGE */
onAuthStateChanged(auth, async (user)=>{
  if(!user) return; // if they open directly without login, save button will still block

  const ref = doc(db,"students",user.uid);
  const snap = await getDoc(ref);
  if(snap.exists()){
    // already have profile â†’ go to directory
    window.location.href = "directory.html";
  }
});
</script>

</body>
</html>
